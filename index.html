<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antiposta - API Testing Tool</title>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Dark Theme (Fixed) */
        :root {
            --bg-primary: #1e1e1e;
            --bg-secondary: #2d2d2d;
            --panel-bg: #2d2d2d;
            --input-bg: #3d3d3d;
            --text-color: #ffffff;
            --border-color: #404040;
            --accent-color: #64b5f6;
            --accent-hover: #42a5f5;
            --button-bg: #64b5f6;
            --button-hover: #42a5f5;
            --button-text: #ffffff;
            --error-color: #ef5350;
            --success-color: #66bb6a;
            --disabled-color: #666666;
            --hover-color: #3d3d3d;
            --logo-bg: #2d2d2d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
            background-color: var(--bg-primary);
            color: var(--text-color);
        }

        /* Base Layout */
        .app-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            grid-template-rows: 1fr auto;
            height: 100vh;
            overflow: hidden;
        }

        /* Logo Bar */
        .logo-bar {
            background-color: var(--logo-bg);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .logo-bar img {
            height: 60px;
            width: auto;
        }

        .logo-bar .subtitle {
            color: var(--text-color);
            font-style: italic;
            opacity: 0.9;
            font-size: 0.8rem;
            text-align: center;
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .collections-panel,
        .history-panel {
            padding: 1rem;
            overflow-y: auto;
        }

        .collections-panel h2,
        .history-panel h2 {
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            color: var(--text-color);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Request Panel */
        .request-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 1rem;
            gap: 1rem;
            background: var(--panel-bg);
        }

        /* Request URL Bar */
        .request-url-bar {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .http-method {
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem;
            min-width: 100px;
        }

        .request-url {
            flex: 1;
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem;
        }

        .send-request {
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
        }

        .send-request:hover {
            background: var(--button-hover);
        }

        .copy-curl-btn {
            background: var(--bg-secondary);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .copy-curl-btn:hover {
            background: var(--hover-color);
        }

        /* Tabs */
        .request-tabs {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .tab-headers {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .tab-btn {
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab-btn:hover {
            background: var(--hover-color);
        }

        .tab-btn.active {
            border-bottom: 2px solid var(--accent-color);
            color: var(--accent-color);
        }

        .tab-content {
            flex: 1;
            overflow: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        .tab-pane {
            display: none;
            height: 100%;
        }

        .tab-pane.active {
            display: flex;
            flex-direction: column;
        }

        /* Body Tab Specific */
        .body-tab {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .body-tab.active {
            display: flex;
        }

        .body-type-selector {
            margin-bottom: 1rem;
        }

        .body-type {
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem;
            width: 200px;
        }

        /* Key Value Editor */
        .key-value-editor {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .key-value-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .key-value-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .key-input, 
        .value-input {
            flex: 1;
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem;
        }

        .delete-row-btn {
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 4px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .add-row-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.5rem;
            cursor: pointer;
            align-self: flex-start;
        }

        .add-row-btn:hover {
            background: var(--accent-hover);
        }

        /* Body Editors */
        .body-editors {
            display: flex;
            flex-direction: column;
            height: 100%;
            margin-top: 1rem;
        }

        .body-editor {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .json-input, 
        .text-input {
            flex: 1;
            min-height: 150px; /* Approximately 4 lines of text */
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem;
            font-family: monospace;
            resize: vertical;
            overflow: auto;
        }

        .json-error {
            color: var(--error-color);
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        /* Response Container */
        .response-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }

        .response-header {
            display: flex;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .response-tabs {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        /* Environment Bar */
        .environment-bar {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }

        #environment-selector {
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem;
        }

        button {
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
        }

        button:hover {
            background: var(--button-hover);
        }

        /* Help content styling */
        #help-content ul {
            padding-left: 2rem;
            margin: 1rem 0;
            list-style-type: disc;
        }

        #help-content ol {
            padding-left: 2rem;
            margin: 1rem 0;
        }

        #help-content li {
            margin-bottom: 0.5rem;
        }

        /* Keep the help topics sidebar without indentation */
        #help-topics {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #help-topics li {
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Logo Bar -->
            <div class="logo-bar">
                <img src="antiposta-logo.png" alt="Antiposta Logo">
                <span class="subtitle">A delicious pre-dinner snack that you can use to test your API</span>
            </div>
            <div class="collections-panel">
                <h2>Collections</h2>
                <div id="collections-tree"></div>
            </div>
            <div class="history-panel">
                <h2>History</h2>
                <div id="request-history"></div>
            </div>
            <div class="help-panel" style="margin-top: auto; padding: 1rem; border-top: 1px solid var(--border-color);">
                <button id="help-button" aria-label="Help" title="Show Help" style="display: flex; align-items: center; gap: 8px; background: none; border: none; color: var(--text-color); cursor: pointer; padding: 8px; border-radius: 4px; width: 100%; justify-content: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="min-width: 16px;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <span>Help</span>
                </button>
            </div>
            <div class="github-link" style="display: flex; justify-content: center; align-items: center; padding: 1rem; margin-top: 1rem; margin-bottom: 1rem;">
                <a href="https://github.com/dolan/antiposta" target="_blank" style="color: var(--accent-color); text-decoration: none; padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 4px; transition: background-color 0.2s ease;">GitHub Project</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="request-panel">
                <div class="request-url-bar">
                    <select class="http-method">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                        <option value="PATCH">PATCH</option>
                        <option value="HEAD">HEAD</option>
                        <option value="OPTIONS">OPTIONS</option>
                    </select>
                    <input type="text" class="request-url" placeholder="Enter request URL">
                    <button class="send-request">Send</button>
                    <button class="copy-curl-btn" title="Copy as cURL command">📋 cURL</button>
                </div>

                <div class="request-tabs">
                    <div class="tab-headers">
                        <button class="tab-btn active" data-tab="headers">Headers</button>
                        <button class="tab-btn" data-tab="params">Params</button>
                        <button class="tab-btn" data-tab="body">Body</button>
                        <button class="tab-btn" data-tab="auth">Auth</button>
                    </div>
                    <div class="tab-content">
                        <div class="headers-tab tab-pane active">
                            <div class="key-value-editor" id="headers-editor">
                                <div class="key-value-list" id="headers-list">
                                    <div class="key-value-row">
                                        <input type="text" class="key-input" placeholder="Key">
                                        <input type="text" class="value-input" placeholder="Value">
                                        <button class="delete-row-btn" title="Remove row">×</button>
                                    </div>
                                </div>
                                <button class="add-row-btn" id="add-header-btn">Add Header</button>
                            </div>
                        </div>
                        <div class="params-tab tab-pane">
                            <div class="key-value-editor" id="params-editor">
                                <div class="key-value-list" id="params-list">
                                    <div class="key-value-row">
                                        <input type="text" class="key-input" placeholder="Key">
                                        <input type="text" class="value-input" placeholder="Value">
                                        <button class="delete-row-btn" title="Remove row">×</button>
                                    </div>
                                </div>
                                <button class="add-row-btn" id="add-param-btn">Add Parameter</button>
                            </div>
                        </div>
                        <div class="body-tab tab-pane">
                            <div class="body-type-selector">
                                <select class="body-type">
                                    <option value="none">None</option>
                                    <option value="json">JSON</option>
                                    <option value="form">Form Data</option>
                                    <option value="text">Raw Text</option>
                                </select>
                            </div>
                            <div class="body-editors">
                                <div class="json-editor body-editor" style="display: none;">
                                    <textarea class="json-input" placeholder="Enter JSON data"></textarea>
                                    <div class="json-error"></div>
                                </div>
                                <div class="form-editor body-editor" style="display: none;">
                                    <div class="key-value-editor" id="form-editor">
                                        <div class="key-value-list" id="form-list">
                                            <div class="key-value-row">
                                                <input type="text" class="key-input" placeholder="Key">
                                                <input type="text" class="value-input" placeholder="Value">
                                                <button class="delete-row-btn" title="Remove row">×</button>
                                            </div>
                                        </div>
                                        <button class="add-row-btn" id="add-form-btn">Add Form Field</button>
                                    </div>
                                </div>
                                <div class="text-editor body-editor" style="display: none;">
                                    <textarea class="text-input" placeholder="Enter raw text"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="auth-tab tab-pane">
                            <!-- OAuth2 Authentication -->
                            <div id="oauth2-form" style="display: flex; flex-direction: column; gap: 1rem;">
                                <h3>OAuth2 Authentication</h3>
                                
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <label for="grant-type" style="width: 120px;">Grant Type:</label>
                                    <select id="grant-type" style="flex: 1; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.5rem;">
                                        <option value="client_credentials">Client Credentials</option>
                                        <option value="password">Password</option>
                                    </select>
                                </div>
                                
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <label for="token-url" style="width: 120px;">Token URL:</label>
                                    <input type="text" id="token-url" placeholder="https://example.com/oauth/token" style="flex: 1; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.5rem;">
                                </div>
                                
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <label for="client-id" style="width: 120px;">Client ID:</label>
                                    <input type="text" id="client-id" placeholder="client_id" style="flex: 1; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.5rem;">
                                </div>
                                
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <label for="client-secret" style="width: 120px;">Client Secret:</label>
                                    <input type="password" id="client-secret" placeholder="client_secret" style="flex: 1; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.5rem;">
                                </div>
                                
                                <div id="password-credentials" style="display: none; flex-direction: column; gap: 0.5rem;">
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <label for="username" style="width: 120px;">Username:</label>
                                        <input type="text" id="username" placeholder="username" style="flex: 1; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.5rem;">
                                    </div>
                                    
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <label for="password" style="width: 120px;">Password:</label>
                                        <input type="password" id="password" placeholder="password" style="flex: 1; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.5rem;">
                                    </div>
                                </div>
                                
                                <div>
                                    <button id="fetch-token" style="background: var(--button-bg); color: var(--button-text); border: none; border-radius: 4px; padding: 0.5rem 1rem; cursor: pointer;">Fetch Token</button>
                                </div>
                                
                                <div id="token-result" style="margin-top: 1rem; display: none;">
                                    <h4>Token Result</h4>
                                    <pre id="token-response" style="background: var(--input-bg); padding: 0.5rem; border-radius: 4px; overflow: auto; max-height: 150px;"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="response-container">
                    <div class="response-header">
                        <div class="status">Status: -</div>
                        <div class="time">Time: -</div>
                        <div class="size">Size: -</div>
                    </div>
                    <div class="response-tabs">
                        <div class="tab-headers">
                            <button class="tab-btn active" data-tab="response">Response</button>
                            <button class="tab-btn" data-tab="headers">Headers</button>
                        </div>
                        <div class="tab-content">
                            <div class="response-body tab-pane active">
                                <pre>Response will appear here</pre>
                            </div>
                            <div class="response-headers tab-pane">
                                <pre>Response headers will appear here</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Environment Selector -->
        <div class="environment-bar">
            <select id="environment-selector">
                <option value="">No Environment</option>
            </select>
            <button id="manage-env">Manage Environments</button>
            <button id="split-view-toggle">Toggle Split View</button>
        </div>
    </div>

    <!-- Environment Management Modal -->
    <div id="env-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000;">
        <div style="position: relative; width: 80%; max-width: 800px; margin: 50px auto; background-color: var(--panel-bg); border-radius: 8px; padding: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <button id="close-modal" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--text-color); font-size: 20px; cursor: pointer;">×</button>
            
            <h2 style="margin-bottom: 20px; color: var(--text-color);">Manage Environments</h2>
            
            <div style="display: flex; gap: 20px; height: 400px;">
                <!-- Environment List -->
                <div style="flex: 1; display: flex; flex-direction: column; gap: 10px;">
                    <h3 style="margin-bottom: 10px; color: var(--text-color);">Environments</h3>
                    <div id="env-list" style="flex: 1; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 10px;">
                        <!-- Environment items will be added here -->
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-env-name" placeholder="New environment name" style="flex: 1; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 8px;">
                        <button id="add-env-btn" style="background: var(--accent-color); color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer;">Add</button>
                    </div>
                </div>
                
                <!-- Environment Variables -->
                <div style="flex: 2; display: flex; flex-direction: column;">
                    <h3 id="current-env-name" style="margin-bottom: 10px; color: var(--text-color);">Variables</h3>
                    <div id="env-variables" style="flex: 1; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 10px;">
                        <div class="key-value-list" id="variables-list">
                            <!-- Variable rows will be added here -->
                        </div>
                        <button class="add-row-btn" id="add-variable-btn" style="margin-top: 10px; background: var(--accent-color); color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer;">Add Variable</button>
                    </div>
                    <div style="display: flex; justify-content: flex-end; margin-top: 10px; gap: 10px;">
                        <button id="delete-env-btn" style="background: var(--error-color); color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer;">Delete Environment</button>
                        <button id="save-env-btn" style="background: var(--success-color); color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer;">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Overlay -->
    <div id="help-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2000;">
        <div id="help-container" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 800px; max-height: 80vh; background-color: var(--panel-bg); border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); overflow: hidden; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
                <h2 id="help-title" style="margin: 0; color: var(--text-color);">Help</h2>
                <button id="close-help" style="background: none; border: none; color: var(--text-color); font-size: 20px; cursor: pointer;">×</button>
            </div>
            <div style="display: flex; height: 100%;">
                <div style="width: 200px; background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); padding: 1rem; overflow-y: auto;">
                    <h3 style="margin-top: 0; color: var(--text-color);">Topics</h3>
                    <ul id="help-topics">
                        <li><a href="#general" class="help-topic-link" data-topic="general" style="color: var(--accent-color); text-decoration: none; display: block; padding: 8px; border-radius: 4px;">General</a></li>
                        <li><a href="#request-url" class="help-topic-link" data-topic="request-url" style="color: var(--accent-color); text-decoration: none; display: block; padding: 8px; border-radius: 4px;">Request URL</a></li>
                        <li><a href="#headers" class="help-topic-link" data-topic="headers" style="color: var(--accent-color); text-decoration: none; display: block; padding: 8px; border-radius: 4px;">Headers</a></li>
                        <li><a href="#params" class="help-topic-link" data-topic="params" style="color: var(--accent-color); text-decoration: none; display: block; padding: 8px; border-radius: 4px;">Parameters</a></li>
                        <li><a href="#body" class="help-topic-link" data-topic="body" style="color: var(--accent-color); text-decoration: none; display: block; padding: 8px; border-radius: 4px;">Request Body</a></li>
                        <li><a href="#auth" class="help-topic-link" data-topic="auth" style="color: var(--accent-color); text-decoration: none; display: block; padding: 8px; border-radius: 4px;">Authentication</a></li>
                        <li><a href="#response" class="help-topic-link" data-topic="response" style="color: var(--accent-color); text-decoration: none; display: block; padding: 8px; border-radius: 4px;">Response</a></li>
                        <li><a href="#environments" class="help-topic-link" data-topic="environments" style="color: var(--accent-color); text-decoration: none; display: block; padding: 8px; border-radius: 4px;">Environments</a></li>
                        <li><a href="#curl" class="help-topic-link" data-topic="curl" style="color: var(--accent-color); text-decoration: none; display: block; padding: 8px; border-radius: 4px;">cURL Export</a></li>
                        <li><a href="#history" class="help-topic-link" data-topic="history" style="color: var(--accent-color); text-decoration: none; display: block; padding: 8px; border-radius: 4px;">History</a></li>
                    </ul>
                </div>
                <div id="help-content" style="flex: 1; padding: 1rem; overflow-y: auto;">
                    <!-- Help content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Help Content Templates -->
    <template id="help-general">
        <h2>Welcome to Antiposta</h2>
        <p>Antiposta is a lightweight API testing tool that runs entirely in your browser. No data is sent to any server unless you explicitly make an API request.</p>
        
        <h3>Basic Usage</h3>
        <ol>
            <li>Enter a URL in the request URL field</li>
            <li>Select the HTTP method (GET, POST, etc.)</li>
            <li>Configure headers, parameters, or body if needed</li>
            <li>Click the Send button to make the request</li>
            <li>View the response below</li>
        </ol>
        
        <h3>Key Features</h3>
        <ul>
            <li>Make HTTP requests with different methods</li>
            <li>Set custom headers</li>
            <li>Add URL parameters</li>
            <li>Send different types of request bodies (JSON, form data, text)</li>
            <li>View formatted responses</li>
            <li>Use environments to store and reuse variables</li>
            <li>Export requests as cURL commands</li>
            <li>Automatic request history</li>
        </ul>
        
        <h3>Keyboard Shortcuts</h3>
        <ul>
            <li><strong>Ctrl/Cmd + Enter</strong>: Send request</li>
            <li><strong>Ctrl/Cmd + L</strong>: Focus URL bar</li>
            <li><strong>Ctrl/Cmd + K</strong>: Copy as cURL</li>
            <li><strong>F1</strong>: Show help</li>
            <li><strong>Escape</strong>: Close modals</li>
        </ul>
        
        <p>Click on a topic in the sidebar to learn more about specific features.</p>
    </template>

    <template id="help-request-url">
        <h2>Request URL</h2>
        <p>The request URL is the address of the API endpoint you want to call.</p>
        
        <h3>HTTP Methods</h3>
        <p>Select the appropriate HTTP method for your request:</p>
        <ul>
            <li><strong>GET</strong>: Retrieve data from the server</li>
            <li><strong>POST</strong>: Send data to create a resource</li>
            <li><strong>PUT</strong>: Update an existing resource</li>
            <li><strong>DELETE</strong>: Remove a resource</li>
            <li><strong>PATCH</strong>: Partially update a resource</li>
            <li><strong>HEAD</strong>: Same as GET but returns only headers</li>
            <li><strong>OPTIONS</strong>: Get supported methods for a resource</li>
        </ul>
        
        <h3>Using Environment Variables</h3>
        <p>You can use environment variables in your URL with the <code>{{variableName}}</code> syntax.</p>
        <p>Example: <code>https://{{baseUrl}}/api/users</code></p>
        
        <p>See the <a href="#environments" class="help-topic-link" data-topic="environments">Environments</a> section for more details.</p>
    </template>

    <template id="help-headers">
        <h2>Headers</h2>
        <p>HTTP headers let you pass additional information with your request.</p>
        
        <h3>Common Headers</h3>
        <ul>
            <li><strong>Content-Type</strong>: Specifies the format of the request body (e.g., <code>application/json</code>)</li>
            <li><strong>Accept</strong>: Indicates what content types the client can process (e.g., <code>application/json</code>)</li>
            <li><strong>Authorization</strong>: Contains credentials for authenticating the client</li>
            <li><strong>User-Agent</strong>: Identifies the client making the request</li>
        </ul>
        
        <h3>Adding Headers</h3>
        <ol>
            <li>Click the "Add Header" button</li>
            <li>Enter the header name in the Key field</li>
            <li>Enter the header value in the Value field</li>
        </ol>
        
        <h3>Using Environment Variables</h3>
        <p>You can use environment variables in headers with the <code>{{variableName}}</code> syntax.</p>
        <p>Example: <code>Authorization: Bearer {{accessToken}}</code></p>
    </template>

    <template id="help-params">
        <h2>Parameters</h2>
        <p>URL parameters are appended to the URL as a query string.</p>
        
        <h3>Adding Parameters</h3>
        <ol>
            <li>Click the "Add Parameter" button</li>
            <li>Enter the parameter name in the Key field</li>
            <li>Enter the parameter value in the Value field</li>
        </ol>
        
        <p>Parameters will be automatically appended to your URL when you send the request.</p>
        <p>Example: If your URL is <code>https://api.example.com/users</code> and you add a parameter <code>page=2</code>, the final URL will be <code>https://api.example.com/users?page=2</code></p>
        
        <h3>Using Environment Variables</h3>
        <p>You can use environment variables in parameters with the <code>{{variableName}}</code> syntax.</p>
        <p>Example: <code>user_id: {{userId}}</code></p>
    </template>

    <template id="help-body">
        <h2>Request Body</h2>
        <p>The request body contains data you want to send to the server. It's typically used with POST, PUT, and PATCH requests.</p>
        
        <h3>Body Types</h3>
        <ul>
            <li><strong>None</strong>: No body is sent with the request</li>
            <li><strong>JSON</strong>: Send data in JSON format</li>
            <li><strong>Form Data</strong>: Send data as form fields</li>
            <li><strong>Raw Text</strong>: Send plain text data</li>
        </ul>
        
        <h3>JSON</h3>
        <p>For JSON bodies, enter valid JSON in the editor. The editor will automatically format your JSON when you click outside the text area.</p>
        <p>Example:</p>
        <pre>{
  "name": "John Doe",
  "email": "john@example.com"
}</pre>
        
        <h3>Form Data</h3>
        <p>For form data, add key-value pairs that will be sent as <code>application/x-www-form-urlencoded</code> or <code>multipart/form-data</code>.</p>
        
        <h3>Raw Text</h3>
        <p>For raw text, simply enter the text you want to send. This is useful for custom formats or plain text.</p>
        
        <h3>Using Environment Variables</h3>
        <p>You can use environment variables in the request body with the <code>{{variableName}}</code> syntax.</p>
    </template>

    <template id="help-auth">
        <h2>Authentication</h2>
        <p>Authentication allows you to identify yourself to the API.</p>
        
        <p>This feature will be implemented in a future update.</p>
        
        <h3>Common Authentication Methods</h3>
        <ul>
            <li><strong>Basic Auth</strong>: Username and password encoded in Base64</li>
            <li><strong>Bearer Token</strong>: JWT or OAuth token sent in the Authorization header</li>
            <li><strong>API Key</strong>: A key sent in headers, query parameters, or cookies</li>
            <li><strong>OAuth 2.0</strong>: Token-based authentication with various flows</li>
        </ul>
        
        <h3>Using Environment Variables</h3>
        <p>It's recommended to store authentication credentials as environment variables for security and reusability.</p>
        <p>Example: <code>Authorization: Bearer {{accessToken}}</code></p>
    </template>

    <template id="help-response">
        <h2>Response</h2>
        <p>The response section shows the result of your API request.</p>
        
        <h3>Response Information</h3>
        <ul>
            <li><strong>Status</strong>: The HTTP status code and text (e.g., 200 OK, 404 Not Found)</li>
            <li><strong>Time</strong>: How long the request took to complete</li>
            <li><strong>Size</strong>: The size of the response body</li>
        </ul>
        
        <h3>Response Tabs</h3>
        <ul>
            <li><strong>Response</strong>: Shows the response body. JSON responses are automatically formatted.</li>
            <li><strong>Headers</strong>: Shows the response headers returned by the server.</li>
        </ul>
        
        <h3>Status Codes</h3>
        <p>Common HTTP status codes:</p>
        <ul>
            <li><strong>2xx</strong>: Success (200 OK, 201 Created, 204 No Content)</li>
            <li><strong>3xx</strong>: Redirection (301 Moved Permanently, 302 Found)</li>
            <li><strong>4xx</strong>: Client Error (400 Bad Request, 401 Unauthorized, 404 Not Found)</li>
            <li><strong>5xx</strong>: Server Error (500 Internal Server Error, 503 Service Unavailable)</li>
        </ul>
    </template>

    <template id="help-environments">
        <h2>Environments</h2>
        <p>Environments allow you to store variables that can be reused across requests.</p>
        
        <h3>Creating an Environment</h3>
        <ol>
            <li>Click the "Manage Environments" button at the bottom of the screen</li>
            <li>Enter a name for your environment and click "Add"</li>
            <li>Select the environment from the list</li>
            <li>Add variables with their values</li>
            <li>Click "Save Changes"</li>
        </ol>
        
        <h3>Using Environment Variables</h3>
        <p>You can use environment variables in your requests with the <code>{{variableName}}</code> syntax.</p>
        <p>Examples:</p>
        <ul>
            <li>URL: <code>https://{{baseUrl}}/api/users</code></li>
            <li>Headers: <code>Authorization: Bearer {{token}}</code></li>
            <li>Body: <code>{"userId": "{{userId}}"}</code></li>
        </ul>
        
        <h3>Switching Environments</h3>
        <p>Use the environment selector at the bottom of the screen to switch between environments.</p>
        
        <h3>Use Cases</h3>
        <ul>
            <li>Switching between development, staging, and production APIs</li>
            <li>Storing authentication tokens</li>
            <li>Reusing common values across multiple requests</li>
        </ul>
    </template>

    <template id="help-curl">
        <h2>cURL Export</h2>
        <p>Antiposta can generate cURL commands from your requests, making it easy to share requests or use them in scripts.</p>
        
        <h3>Using cURL Export</h3>
        <ol>
            <li>Configure your request (URL, method, headers, body, etc.)</li>
            <li>Click the "📋 cURL" button next to the Send button</li>
            <li>The cURL command will be automatically copied to your clipboard</li>
            <li>Paste it into your terminal or scripts</li>
        </ol>
        
        <h3>Keyboard Shortcut</h3>
        <p>You can also use <strong>Ctrl/Cmd + K</strong> to quickly copy the current request as a cURL command.</p>
        
        <h3>What's Included</h3>
        <p>The generated cURL command includes:</p>
        <ul>
            <li>HTTP method (-X flag)</li>
            <li>All headers (-H flags)</li>
            <li>URL parameters (appended to URL)</li>
            <li>Request body (-d flag for JSON, form data, or text)</li>
            <li>Environment variables are resolved to their actual values</li>
        </ul>
        
        <h3>Example Output</h3>
        <pre>curl -X POST \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer token123" \
  -d '{"name": "John", "email": "john@example.com"}' \
  "https://api.example.com/users"</pre>
        
        <h3>Tips</h3>
        <ul>
            <li>Environment variables are automatically replaced with their values</li>
            <li>Use this feature to document API calls in your projects</li>
            <li>Perfect for sharing requests with team members</li>
            <li>Great for converting GUI requests to automation scripts</li>
        </ul>
    </template>

    <template id="help-history">
        <h2>Request History</h2>
        <p>Antiposta automatically saves your recent requests, making it easy to repeat or modify previous API calls.</p>
        
        <h3>How It Works</h3>
        <ul>
            <li>Every successful request is automatically saved to history</li>
            <li>History is stored locally in your browser</li>
            <li>The 20 most recent requests are kept</li>
            <li>Duplicate requests (same method + URL) are merged</li>
        </ul>
        
        <h3>Using History</h3>
        <ol>
            <li>Look for the "History" panel in the left sidebar</li>
            <li>Click on any history item to load that request</li>
            <li>All request details are restored: headers, parameters, body, etc.</li>
            <li>Make any needed modifications and send again</li>
        </ol>
        
        <h3>History Information</h3>
        <p>Each history item shows:</p>
        <ul>
            <li><strong>HTTP Method</strong>: GET, POST, etc.</li>
            <li><strong>URL</strong>: The request endpoint</li>
            <li><strong>Timestamp</strong>: When the request was made</li>
        </ul>
        
        <h3>What's Saved</h3>
        <p>The complete request is saved including:</p>
        <ul>
            <li>HTTP method and URL</li>
            <li>All headers</li>
            <li>URL parameters</li>
            <li>Request body (JSON, form data, or text)</li>
            <li>Body type selection</li>
        </ul>
        
        <h3>Privacy</h3>
        <ul>
            <li>History is stored locally in your browser only</li>
            <li>No data is sent to external servers</li>
            <li>History persists between browser sessions</li>
            <li>You can clear history by clearing browser data</li>
        </ul>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Environment management
            let environments = [];
            let currentEnvironment = null;
            
            // Request history management
            let requestHistory = [];
            const MAX_HISTORY_ITEMS = 20;
            
            // Load environments from localStorage
            function loadEnvironments() {
                const storedEnvironments = localStorage.getItem('antiposta_environments');
                if (storedEnvironments) {
                    try {
                        environments = JSON.parse(storedEnvironments);
                    } catch (e) {
                        console.error('Failed to parse stored environments:', e);
                        environments = [];
                    }
                }
                
                updateEnvironmentSelector();
            }
            
            // Load request history from localStorage
            function loadRequestHistory() {
                const storedHistory = localStorage.getItem('antiposta_request_history');
                if (storedHistory) {
                    try {
                        requestHistory = JSON.parse(storedHistory);
                    } catch (e) {
                        console.error('Failed to parse stored history:', e);
                        requestHistory = [];
                    }
                }
                
                updateHistoryDisplay();
            }
            
            // Save request history to localStorage
            function saveRequestHistory() {
                localStorage.setItem('antiposta_request_history', JSON.stringify(requestHistory));
                updateHistoryDisplay();
            }
            
            // Add a request to history
            function addToHistory(method, url, headers, params, body, bodyType) {
                const historyItem = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    method: method,
                    url: url,
                    headers: headers,
                    params: params,
                    body: body,
                    bodyType: bodyType,
                    name: `${method} ${url}`.substring(0, 50) + (url.length > 40 ? '...' : '')
                };
                
                // Remove duplicate URLs with same method
                requestHistory = requestHistory.filter(item => 
                    !(item.method === method && item.url === url)
                );
                
                // Add to beginning of array
                requestHistory.unshift(historyItem);
                
                // Limit history size
                if (requestHistory.length > MAX_HISTORY_ITEMS) {
                    requestHistory = requestHistory.slice(0, MAX_HISTORY_ITEMS);
                }
                
                saveRequestHistory();
            }
            
            // Load a request from history
            function loadFromHistory(historyId) {
                const historyItem = requestHistory.find(item => item.id === historyId);
                if (!historyItem) return;
                
                // Set method and URL
                document.querySelector('.http-method').value = historyItem.method;
                document.querySelector('.request-url').value = historyItem.url;
                
                // Clear and set headers
                const headersList = document.getElementById('headers-list');
                headersList.innerHTML = '';
                historyItem.headers.forEach(header => {
                    addKeyValueRow(headersList);
                    const lastRow = headersList.lastElementChild;
                    lastRow.querySelector('.key-input').value = header.key;
                    lastRow.querySelector('.value-input').value = header.value;
                });
                if (headersList.children.length === 0) {
                    addKeyValueRow(headersList);
                }
                
                // Clear and set params
                const paramsList = document.getElementById('params-list');
                paramsList.innerHTML = '';
                historyItem.params.forEach(param => {
                    addKeyValueRow(paramsList);
                    const lastRow = paramsList.lastElementChild;
                    lastRow.querySelector('.key-input').value = param.key;
                    lastRow.querySelector('.value-input').value = param.value;
                });
                if (paramsList.children.length === 0) {
                    addKeyValueRow(paramsList);
                }
                
                // Set body type and content
                document.querySelector('.body-type').value = historyItem.bodyType || 'none';
                document.querySelector('.body-type').dispatchEvent(new Event('change'));
                
                if (historyItem.bodyType === 'json') {
                    document.querySelector('.json-input').value = historyItem.body || '';
                } else if (historyItem.bodyType === 'text') {
                    document.querySelector('.text-input').value = historyItem.body || '';
                } else if (historyItem.bodyType === 'form' && historyItem.body) {
                    const formList = document.getElementById('form-list');
                    formList.innerHTML = '';
                    historyItem.body.forEach(formField => {
                        addKeyValueRow(formList);
                        const lastRow = formList.lastElementChild;
                        lastRow.querySelector('.key-input').value = formField.key;
                        lastRow.querySelector('.value-input').value = formField.value;
                    });
                    if (formList.children.length === 0) {
                        addKeyValueRow(formList);
                    }
                }
            }
            
            // Update history display in sidebar
            function updateHistoryDisplay() {
                const historyContainer = document.getElementById('request-history');
                historyContainer.innerHTML = '';
                
                if (requestHistory.length === 0) {
                    historyContainer.innerHTML = '<p style="color: var(--disabled-color); font-style: italic;">No recent requests</p>';
                    return;
                }
                
                requestHistory.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.style.cssText = `
                        padding: 8px;
                        border-radius: 4px;
                        cursor: pointer;
                        margin-bottom: 4px;
                        background: var(--input-bg);
                        border: 1px solid var(--border-color);
                        transition: background-color 0.2s ease;
                    `;
                    
                    historyItem.innerHTML = `
                        <div style="font-weight: bold; font-size: 0.9rem; color: var(--accent-color);">${item.method}</div>
                        <div style="font-size: 0.8rem; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.url}</div>
                        <div style="font-size: 0.7rem; color: var(--disabled-color);">${new Date(item.timestamp).toLocaleString()}</div>
                    `;
                    
                    historyItem.addEventListener('click', function() {
                        loadFromHistory(item.id);
                    });
                    
                    historyItem.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = 'var(--hover-color)';
                    });
                    
                    historyItem.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = 'var(--input-bg)';
                    });
                    
                    historyContainer.appendChild(historyItem);
                });
            }
            
            // Save environments to localStorage
            function saveEnvironments() {
                localStorage.setItem('antiposta_environments', JSON.stringify(environments));
                updateEnvironmentSelector();
            }
            
            // Update the environment selector dropdown
            function updateEnvironmentSelector() {
                const selector = document.getElementById('environment-selector');
                
                // Clear existing options except the first one
                while (selector.options.length > 1) {
                    selector.remove(1);
                }
                
                // Add environment options
                environments.forEach(env => {
                    const option = document.createElement('option');
                    option.value = env.id;
                    option.textContent = env.name;
                    selector.appendChild(option);
                });
                
                // Select the current environment if there is one
                if (currentEnvironment) {
                    selector.value = currentEnvironment.id;
                }
            }
            
            // Environment selector change handler
            document.getElementById('environment-selector').addEventListener('change', function() {
                const envId = this.value;
                
                if (envId === '') {
                    currentEnvironment = null;
                } else {
                    currentEnvironment = environments.find(env => env.id === envId);
                }
                
                // Save the current environment ID to localStorage
                localStorage.setItem('antiposta_current_environment', envId);
            });
            
            // Manage environments button
            document.getElementById('manage-env').addEventListener('click', function() {
                openEnvironmentModal();
            });
            
            // Close modal button
            document.getElementById('close-modal').addEventListener('click', function() {
                document.getElementById('env-modal').style.display = 'none';
            });
            
            // Add environment button
            document.getElementById('add-env-btn').addEventListener('click', function() {
                const nameInput = document.getElementById('new-env-name');
                const name = nameInput.value.trim();
                
                if (name === '') {
                    alert('Please enter an environment name');
                    return;
                }
                
                // Check for duplicate names
                if (environments.some(env => env.name === name)) {
                    alert('An environment with this name already exists');
                    return;
                }
                
                // Create new environment
                const newEnv = {
                    id: Date.now().toString(),
                    name: name,
                    variables: []
                };
                
                environments.push(newEnv);
                saveEnvironments();
                
                // Clear input and update UI
                nameInput.value = '';
                updateEnvironmentList();
                selectEnvironment(newEnv.id);
            });
            
            // Delete environment button
            document.getElementById('delete-env-btn').addEventListener('click', function() {
                if (!currentEnvironment) {
                    alert('No environment selected');
                    return;
                }
                
                if (confirm(`Are you sure you want to delete the environment "${currentEnvironment.name}"?`)) {
                    // Remove the environment
                    environments = environments.filter(env => env.id !== currentEnvironment.id);
                    
                    // Update current environment
                    if (environments.length > 0) {
                        currentEnvironment = environments[0];
                    } else {
                        currentEnvironment = null;
                    }
                    
                    saveEnvironments();
                    updateEnvironmentList();
                    updateVariablesList();
                }
            });
            
            // Save environment changes button
            document.getElementById('save-env-btn').addEventListener('click', function() {
                if (!currentEnvironment) {
                    alert('No environment selected');
                    return;
                }
                
                // Get variables from the UI
                const variables = [];
                document.querySelectorAll('#variables-list .key-value-row').forEach(row => {
                    const key = row.querySelector('.key-input').value.trim();
                    const value = row.querySelector('.value-input').value.trim();
                    
                    if (key) {
                        variables.push({ key, value });
                    }
                });
                
                // Update the current environment
                currentEnvironment.variables = variables;
                
                // Save to localStorage
                saveEnvironments();
                
                alert('Environment saved successfully');
            });
            
            // Add variable button
            document.getElementById('add-variable-btn').addEventListener('click', function() {
                if (!currentEnvironment) {
                    alert('Please select or create an environment first');
                    return;
                }
                
                addVariableRow();
            });
            
            // Update the environment list in the modal
            function updateEnvironmentList() {
                const list = document.getElementById('env-list');
                list.innerHTML = '';
                
                environments.forEach(env => {
                    const item = document.createElement('div');
                    item.className = 'env-item';
                    item.dataset.id = env.id;
                    item.textContent = env.name;
                    item.style.padding = '8px';
                    item.style.cursor = 'pointer';
                    item.style.borderRadius = '4px';
                    
                    if (currentEnvironment && env.id === currentEnvironment.id) {
                        item.style.backgroundColor = 'var(--accent-color)';
                        item.style.color = 'white';
                    } else {
                        item.style.backgroundColor = 'var(--input-bg)';
                    }
                    
                    item.addEventListener('click', function() {
                        selectEnvironment(env.id);
                    });
                    
                    list.appendChild(item);
                });
            }
            
            // Select an environment in the modal
            function selectEnvironment(envId) {
                currentEnvironment = environments.find(env => env.id === envId);
                
                // Update UI
                document.querySelectorAll('.env-item').forEach(item => {
                    if (item.dataset.id === envId) {
                        item.style.backgroundColor = 'var(--accent-color)';
                        item.style.color = 'white';
                    } else {
                        item.style.backgroundColor = 'var(--input-bg)';
                        item.style.color = 'var(--text-color)';
                    }
                });
                
                // Update variables list
                updateVariablesList();
                
                // Update environment name display
                document.getElementById('current-env-name').textContent = 
                    currentEnvironment ? `Variables for ${currentEnvironment.name}` : 'Variables';
                
                // Update delete button state
                document.getElementById('delete-env-btn').disabled = !currentEnvironment;
                document.getElementById('save-env-btn').disabled = !currentEnvironment;
            }
            
            // Update the variables list for the current environment
            function updateVariablesList() {
                const list = document.getElementById('variables-list');
                list.innerHTML = '';
                
                if (!currentEnvironment) {
                    return;
                }
                
                if (currentEnvironment.variables.length === 0) {
                    // Add an empty row
                    addVariableRow();
                } else {
                    // Add rows for each variable
                    currentEnvironment.variables.forEach(variable => {
                        addVariableRow(variable.key, variable.value);
                    });
                }
            }
            
            // Add a variable row to the variables list
            function addVariableRow(key = '', value = '') {
                const list = document.getElementById('variables-list');
                
                const row = document.createElement('div');
                row.className = 'key-value-row';
                row.innerHTML = `
                    <input type="text" class="key-input" placeholder="Variable Name" value="${key}">
                    <input type="text" class="value-input" placeholder="Value" value="${value}">
                    <button class="delete-row-btn" title="Remove variable">×</button>
                `;
                
                // Add delete handler
                row.querySelector('.delete-row-btn').addEventListener('click', function() {
                    // Don't delete if it's the last row
                    if (list.querySelectorAll('.key-value-row').length <= 1) {
                        // Clear the inputs instead
                        row.querySelectorAll('input').forEach(input => input.value = '');
                    } else {
                        row.remove();
                    }
                });
                
                list.appendChild(row);
            }
            
            // Open the environment modal
            function openEnvironmentModal() {
                updateEnvironmentList();
                updateVariablesList();
                document.getElementById('env-modal').style.display = 'block';
            }
            
            // Variable interpolation function
            function interpolateVariables(text) {
                if (!text || !currentEnvironment) {
                    return text;
                }
                
                // Replace {{variable}} with its value
                return text.replace(/\{\{([^}]+)\}\}/g, (match, variableName) => {
                    const variable = currentEnvironment.variables.find(v => v.key === variableName.trim());
                    return variable ? variable.value : match;
                });
            }
            
            // Generate cURL command from current request
            function generateCurlCommand() {
                const method = document.querySelector('.http-method').value;
                let url = interpolateVariables(document.querySelector('.request-url').value);
                
                if (!url) {
                    alert('Please enter a URL');
                    return null;
                }
                
                // Get headers
                const headers = {};
                document.querySelectorAll('#headers-list .key-value-row').forEach(row => {
                    const key = interpolateVariables(row.querySelector('.key-input').value.trim());
                    const value = interpolateVariables(row.querySelector('.value-input').value.trim());
                    if (key) {
                        headers[key] = value;
                    }
                });
                
                // Get URL parameters
                const params = new URLSearchParams();
                let hasParams = false;
                
                document.querySelectorAll('#params-list .key-value-row').forEach(row => {
                    const key = interpolateVariables(row.querySelector('.key-input').value.trim());
                    const value = interpolateVariables(row.querySelector('.value-input').value.trim());
                    if (key) {
                        params.append(key, value);
                        hasParams = true;
                    }
                });
                
                // Append parameters to URL
                if (hasParams) {
                    url += (url.includes('?') ? '&' : '?') + params.toString();
                }
                
                // Start building curl command
                let curlCommand = `curl -X ${method}`;
                
                // Add headers
                Object.entries(headers).forEach(([key, value]) => {
                    curlCommand += ` \\\n  -H "${key}: ${value}"`;
                });
                
                // Handle request body
                const bodyType = document.querySelector('.body-type').value;
                if (method !== 'GET' && method !== 'HEAD' && bodyType !== 'none') {
                    if (bodyType === 'json') {
                        const jsonText = interpolateVariables(document.querySelector('.json-input').value.trim());
                        if (jsonText) {
                            try {
                                // Validate JSON
                                JSON.parse(jsonText);
                                curlCommand += ` \\\n  -H "Content-Type: application/json"`;
                                curlCommand += ` \\\n  -d '${jsonText}'`;
                            } catch (e) {
                                alert('Invalid JSON: ' + e.message);
                                return null;
                            }
                        }
                    } else if (bodyType === 'form') {
                        const formParams = [];
                        document.querySelectorAll('#form-list .key-value-row').forEach(row => {
                            const key = interpolateVariables(row.querySelector('.key-input').value.trim());
                            const value = interpolateVariables(row.querySelector('.value-input').value.trim());
                            if (key) {
                                formParams.push(`${encodeURIComponent(key)}=${encodeURIComponent(value)}`);
                            }
                        });
                        
                        if (formParams.length > 0) {
                            curlCommand += ` \\\n  -H "Content-Type: application/x-www-form-urlencoded"`;
                            curlCommand += ` \\\n  -d "${formParams.join('&')}"`;
                        }
                    } else if (bodyType === 'text') {
                        const textData = interpolateVariables(document.querySelector('.text-input').value.trim());
                        if (textData) {
                            curlCommand += ` \\\n  -H "Content-Type: text/plain"`;
                            curlCommand += ` \\\n  -d '${textData}'`;
                        }
                    }
                }
                
                // Add URL (always last)
                curlCommand += ` \\\n  "${url}"`;
                
                return curlCommand;
            }
            
            // Override the send request functionality to include variable interpolation
            const originalSendRequestHandler = document.querySelector('.send-request').onclick;
            document.querySelector('.send-request').onclick = function() {
                // Interpolate variables in the URL
                const urlInput = document.querySelector('.request-url');
                const originalUrl = urlInput.value;
                urlInput.value = interpolateVariables(originalUrl);
                
                // Interpolate variables in headers
                document.querySelectorAll('#headers-list .key-value-row').forEach(row => {
                    const keyInput = row.querySelector('.key-input');
                    const valueInput = row.querySelector('.value-input');
                    
                    keyInput.value = interpolateVariables(keyInput.value);
                    valueInput.value = interpolateVariables(valueInput.value);
                });
                
                // Interpolate variables in params
                document.querySelectorAll('#params-list .key-value-row').forEach(row => {
                    const keyInput = row.querySelector('.key-input');
                    const valueInput = row.querySelector('.value-input');
                    
                    keyInput.value = interpolateVariables(keyInput.value);
                    valueInput.value = interpolateVariables(valueInput.value);
                });
                
                // Interpolate variables in body
                const bodyType = document.querySelector('.body-type').value;
                
                if (bodyType === 'json') {
                    const jsonInput = document.querySelector('.json-input');
                    jsonInput.value = interpolateVariables(jsonInput.value);
                } else if (bodyType === 'form') {
                    document.querySelectorAll('#form-list .key-value-row').forEach(row => {
                        const keyInput = row.querySelector('.key-input');
                        const valueInput = row.querySelector('.value-input');
                        
                        keyInput.value = interpolateVariables(keyInput.value);
                        valueInput.value = interpolateVariables(valueInput.value);
                    });
                } else if (bodyType === 'text') {
                    const textInput = document.querySelector('.text-input');
                    textInput.value = interpolateVariables(textInput.value);
                }
                
                // Call the original handler
                const method = document.querySelector('.http-method').value;
                const url = document.querySelector('.request-url').value;
                
                if (!url) {
                    alert('Please enter a URL');
                    return;
                }
                
                // Get headers from the headers editor
                const headers = {};
                document.querySelectorAll('#headers-list .key-value-row').forEach(row => {
                    const key = row.querySelector('.key-input').value.trim();
                    const value = row.querySelector('.value-input').value.trim();
                    if (key) {
                        headers[key] = value;
                    }
                });
                
                // Get request body based on selected type
                let body = null;
                
                if (method !== 'GET' && method !== 'HEAD') {
                    if (bodyType === 'json') {
                        const jsonText = document.querySelector('.json-input').value.trim();
                        if (jsonText) {
                            try {
                                body = JSON.parse(jsonText);
                                headers['Content-Type'] = 'application/json';
                            } catch (e) {
                                alert('Invalid JSON: ' + e.message);
                                return;
                            }
                        }
                    } else if (bodyType === 'form') {
                        const formData = new FormData();
                        let hasData = false;
                        
                        document.querySelectorAll('#form-list .key-value-row').forEach(row => {
                            const key = row.querySelector('.key-input').value.trim();
                            const value = row.querySelector('.value-input').value.trim();
                            if (key) {
                                formData.append(key, value);
                                hasData = true;
                            }
                        });
                        
                        if (hasData) {
                            body = formData;
                        }
                    } else if (bodyType === 'text') {
                        const textData = document.querySelector('.text-input').value.trim();
                        if (textData) {
                            body = textData;
                            headers['Content-Type'] = 'text/plain';
                        }
                    }
                }
                
                // Get URL parameters and append them to the URL
                const params = new URLSearchParams();
                let hasParams = false;
                
                document.querySelectorAll('#params-list .key-value-row').forEach(row => {
                    const key = row.querySelector('.key-input').value.trim();
                    const value = row.querySelector('.value-input').value.trim();
                    if (key) {
                        params.append(key, value);
                        hasParams = true;
                    }
                });
                
                let finalUrl = url;
                if (hasParams) {
                    // Check if URL already has parameters
                    finalUrl += (url.includes('?') ? '&' : '?') + params.toString();
                }
                
                // Update UI to show loading state
                document.querySelector('.status').textContent = 'Status: Loading...';
                document.querySelector('.time').textContent = 'Time: -';
                document.querySelector('.size').textContent = 'Size: -';
                document.querySelector('.response-body pre').textContent = 'Loading...';
                document.querySelector('.response-headers pre').textContent = 'Loading...';
                
                const startTime = Date.now();
                
                // Prepare fetch options
                const fetchOptions = {
                    method: method,
                    headers: headers,
                    // Don't add body for GET and HEAD requests
                    ...(method !== 'GET' && method !== 'HEAD' && body ? { body: bodyType === 'json' ? JSON.stringify(body) : body } : {})
                };
                
                // Make the actual HTTP request
                fetch(finalUrl, fetchOptions)
                    .then(response => {
                        const endTime = Date.now();
                        const responseTime = endTime - startTime;
                        
                        // Update status and time
                        document.querySelector('.status').textContent = `Status: ${response.status} ${response.statusText}`;
                        document.querySelector('.time').textContent = `Time: ${responseTime}ms`;
                        
                        // Clone the response so we can use it twice
                        const responseClone = response.clone();
                        
                        // Get and display response headers
                        const headerText = Array.from(response.headers.entries())
                            .map(([key, value]) => `${key}: ${value}`)
                            .join('\n');
                        
                        document.querySelector('.response-headers pre').textContent = headerText;
                        
                        // Try to parse response as JSON first
                        return responseClone.text().then(text => {
                            let formattedResponse = text;
                            let responseSize = new Blob([text]).size;
                            
                            // Try to format as JSON if it's JSON
                            try {
                                if (response.headers.get('content-type')?.includes('application/json')) {
                                    formattedResponse = JSON.stringify(JSON.parse(text), null, 2);
                                }
                            } catch (e) {
                                // If it's not valid JSON, just show as text
                                console.log('Response is not valid JSON:', e);
                            }
                            
                            // Update size and response body
                            document.querySelector('.size').textContent = `Size: ${formatBytes(responseSize)}`;
                            document.querySelector('.response-body pre').textContent = formattedResponse;
                            
                            // Save to history after successful request
                            const historyHeaders = [];
                            Object.entries(headers).forEach(([key, value]) => {
                                if (key && value) {
                                    historyHeaders.push({ key, value });
                                }
                            });
                            
                            const historyParams = [];
                            document.querySelectorAll('#params-list .key-value-row').forEach(row => {
                                const key = row.querySelector('.key-input').value.trim();
                                const value = row.querySelector('.value-input').value.trim();
                                if (key) {
                                    historyParams.push({ key, value });
                                }
                            });
                            
                            let historyBody = null;
                            if (bodyType === 'json') {
                                historyBody = document.querySelector('.json-input').value.trim();
                            } else if (bodyType === 'text') {
                                historyBody = document.querySelector('.text-input').value.trim();
                            } else if (bodyType === 'form') {
                                historyBody = [];
                                document.querySelectorAll('#form-list .key-value-row').forEach(row => {
                                    const key = row.querySelector('.key-input').value.trim();
                                    const value = row.querySelector('.value-input').value.trim();
                                    if (key) {
                                        historyBody.push({ key, value });
                                    }
                                });
                            }
                            
                            addToHistory(method, originalUrl, historyHeaders, historyParams, historyBody, bodyType);
                        });
                    })
                    .catch(error => {
                        const endTime = Date.now();
                        const responseTime = endTime - startTime;
                        
                        document.querySelector('.status').textContent = 'Status: Error';
                        document.querySelector('.time').textContent = `Time: ${responseTime}ms`;
                        document.querySelector('.size').textContent = 'Size: -';
                        document.querySelector('.response-body pre').textContent = `Error: ${error.message}`;
                        document.querySelector('.response-headers pre').textContent = '';
                    });
                
                // Restore original values after sending the request
                urlInput.value = originalUrl;
            };
            
            // Initialize environments and history
            loadEnvironments();
            loadRequestHistory();
            
            // Load the last selected environment
            const lastEnvId = localStorage.getItem('antiposta_current_environment');
            if (lastEnvId && lastEnvId !== '') {
                const env = environments.find(e => e.id === lastEnvId);
                if (env) {
                    currentEnvironment = env;
                    document.getElementById('environment-selector').value = lastEnvId;
                }
            }
            
            // Tab switching functionality
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // Get the parent tab headers
                    const tabHeaders = this.closest('.tab-headers');
                    // Get the tab content container
                    const tabContent = tabHeaders.nextElementSibling;
                    // Get the tab to show
                    const tabToShow = this.getAttribute('data-tab');
                    
                    // Remove active class from all buttons in this tab group
                    tabHeaders.querySelectorAll('.tab-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Hide all tab panes in this tab group
                    tabContent.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('active');
                    });
                    
                    // Show the selected tab pane
                    const selectedPane = tabContent.querySelector(`.${tabToShow}-tab`);
                    if (selectedPane) {
                        selectedPane.classList.add('active');
                    }
                });
            });

            // Key-value editor functionality
            function setupKeyValueEditor(listId, addBtnId) {
                const list = document.getElementById(listId);
                const addBtn = document.getElementById(addBtnId);
                
                // Add row button click handler
                addBtn.addEventListener('click', function() {
                    addKeyValueRow(list);
                });
                
                // Setup delete handlers for existing rows
                list.querySelectorAll('.delete-row-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        deleteKeyValueRow(this.closest('.key-value-row'), list);
                    });
                });
            }
            
            function addKeyValueRow(list) {
                const newRow = document.createElement('div');
                newRow.className = 'key-value-row';
                newRow.innerHTML = `
                    <input type="text" class="key-input" placeholder="Key">
                    <input type="text" class="value-input" placeholder="Value">
                    <button class="delete-row-btn" title="Remove row">×</button>
                `;
                
                // Add delete handler
                newRow.querySelector('.delete-row-btn').addEventListener('click', function() {
                    deleteKeyValueRow(newRow, list);
                });
                
                // Add to the list
                list.appendChild(newRow);
                
                // Focus the key input
                newRow.querySelector('.key-input').focus();
            }
            
            function deleteKeyValueRow(row, list) {
                // Don't delete if it's the last row
                if (list.querySelectorAll('.key-value-row').length <= 1) {
                    // Clear the inputs instead
                    row.querySelectorAll('input').forEach(input => input.value = '');
                    return;
                }
                
                row.remove();
            }
            
            // Setup all key-value editors
            setupKeyValueEditor('headers-list', 'add-header-btn');
            setupKeyValueEditor('params-list', 'add-param-btn');
            setupKeyValueEditor('form-list', 'add-form-btn');
            
            // Body type selector
            const bodyTypeSelector = document.querySelector('.body-type');
            const bodyEditors = document.querySelectorAll('.body-editor');
            
            bodyTypeSelector.addEventListener('change', function() {
                const selectedType = this.value;
                
                // Hide all editors
                bodyEditors.forEach(editor => {
                    editor.style.display = 'none';
                });
                
                // Show the selected editor
                if (selectedType !== 'none') {
                    const editorToShow = document.querySelector(`.${selectedType}-editor`);
                    if (editorToShow) {
                        editorToShow.style.display = 'flex';
                    }
                }
            });
            
            // JSON editor formatting
            const jsonInput = document.querySelector('.json-input');
            const jsonError = document.querySelector('.json-error');
            
            jsonInput.addEventListener('blur', function() {
                if (this.value.trim() === '') {
                    jsonError.textContent = '';
                    return;
                }
                
                try {
                    const parsed = JSON.parse(this.value);
                    this.value = JSON.stringify(parsed, null, 2);
                    jsonError.textContent = '';
                } catch (e) {
                    jsonError.textContent = 'Invalid JSON: ' + e.message;
                }
            });
            
            // Helper function to format bytes
            function formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }

            // Help system
            const helpButton = document.getElementById('help-button');
            const helpOverlay = document.getElementById('help-overlay');
            const closeHelpButton = document.getElementById('close-help');
            const helpContent = document.getElementById('help-content');
            const helpTitle = document.getElementById('help-title');
            let currentTab = 'headers'; // Default to headers tab
            
            // Show help overlay
            helpButton.addEventListener('click', function() {
                helpOverlay.style.display = 'block';
                showContextualHelp();
            });
            
            // Close help overlay
            closeHelpButton.addEventListener('click', function() {
                helpOverlay.style.display = 'none';
            });
            
            // Close help when clicking outside the help container
            helpOverlay.addEventListener('click', function(event) {
                if (event.target === helpOverlay) {
                    helpOverlay.style.display = 'none';
                }
            });
            
            // Handle help topic links
            document.querySelectorAll('.help-topic-link').forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    const topic = this.getAttribute('data-topic');
                    showHelpTopic(topic);
                    
                    // Update active topic in sidebar
                    document.querySelectorAll('.help-topic-link').forEach(l => {
                        l.style.backgroundColor = 'transparent';
                    });
                    this.style.backgroundColor = 'var(--hover-color)';
                });
            });
            
            // Show contextual help based on current tab
            function showContextualHelp() {
                // Find the active tab
                const activeTabBtn = document.querySelector('.request-tabs .tab-btn.active');
                if (activeTabBtn) {
                    const tabName = activeTabBtn.getAttribute('data-tab');
                    showHelpTopic(tabName);
                    
                    // Update active topic in sidebar
                    document.querySelectorAll('.help-topic-link').forEach(link => {
                        const topic = link.getAttribute('data-topic');
                        if (topic === tabName) {
                            link.style.backgroundColor = 'var(--hover-color)';
                        } else {
                            link.style.backgroundColor = 'transparent';
                        }
                    });
                } else {
                    // Default to general help
                    showHelpTopic('general');
                }
            }
            
            // Show help for a specific topic
            function showHelpTopic(topic) {
                const template = document.getElementById(`help-${topic}`);
                
                if (template) {
                    helpContent.innerHTML = template.innerHTML;
                    helpTitle.textContent = `Help: ${topic.charAt(0).toUpperCase() + topic.slice(1)}`;
                    
                    // Add event listeners to any help topic links in the content
                    helpContent.querySelectorAll('.help-topic-link').forEach(link => {
                        link.addEventListener('click', function(event) {
                            event.preventDefault();
                            const linkedTopic = this.getAttribute('data-topic');
                            showHelpTopic(linkedTopic);
                            
                            // Update active topic in sidebar
                            document.querySelectorAll('.help-topic-link').forEach(l => {
                                const t = l.getAttribute('data-topic');
                                if (t === linkedTopic) {
                                    l.style.backgroundColor = 'var(--hover-color)';
                                } else {
                                    l.style.backgroundColor = 'transparent';
                                }
                            });
                        });
                    });
                } else {
                    // Fallback to general help
                    showHelpTopic('general');
                }
            }
            
            // Update current tab when tab is changed
            document.querySelectorAll('.request-tabs .tab-btn').forEach(button => {
                button.addEventListener('click', function() {
                    currentTab = this.getAttribute('data-tab');
                });
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + Enter: Send request
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    document.querySelector('.send-request').click();
                }
                
                // Ctrl/Cmd + L: Focus URL bar
                if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                    e.preventDefault();
                    document.querySelector('.request-url').focus();
                    document.querySelector('.request-url').select();
                }
                
                // Ctrl/Cmd + K: Copy as cURL
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    document.querySelector('.copy-curl-btn').click();
                }
                
                // F1: Show help
                if (e.key === 'F1') {
                    e.preventDefault();
                    document.getElementById('help-button').click();
                }
                
                // Escape: Close modals
                if (e.key === 'Escape') {
                    // Close help overlay
                    const helpOverlay = document.getElementById('help-overlay');
                    if (helpOverlay.style.display === 'block') {
                        helpOverlay.style.display = 'none';
                        return;
                    }
                    
                    // Close environment modal
                    const envModal = document.getElementById('env-modal');
                    if (envModal.style.display === 'block') {
                        envModal.style.display = 'none';
                        return;
                    }
                    
                    // Close any cURL modal
                    const curlModal = document.querySelector('[style*="z-index: 3000"]');
                    if (curlModal) {
                        curlModal.remove();
                    }
                }
            });

            // cURL Export functionality
            document.querySelector('.copy-curl-btn').addEventListener('click', function() {
                const curlCommand = generateCurlCommand();
                if (curlCommand) {
                    // Copy to clipboard
                    navigator.clipboard.writeText(curlCommand).then(function() {
                        // Visual feedback
                        const originalText = document.querySelector('.copy-curl-btn').textContent;
                        document.querySelector('.copy-curl-btn').textContent = '✅ Copied!';
                        document.querySelector('.copy-curl-btn').style.background = 'var(--success-color)';
                        
                        setTimeout(function() {
                            document.querySelector('.copy-curl-btn').textContent = originalText;
                            document.querySelector('.copy-curl-btn').style.background = 'var(--bg-secondary)';
                        }, 2000);
                    }).catch(function(err) {
                        // Fallback for older browsers
                        console.error('Could not copy text: ', err);
                        
                        // Create a modal to show the cURL command
                        const modal = document.createElement('div');
                        modal.style.cssText = `
                            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                            background-color: rgba(0,0,0,0.7); z-index: 3000;
                            display: flex; align-items: center; justify-content: center;
                        `;
                        
                        const content = document.createElement('div');
                        content.style.cssText = `
                            background: var(--panel-bg); padding: 2rem; border-radius: 8px;
                            max-width: 80%; max-height: 80%; overflow: auto;
                            border: 1px solid var(--border-color);
                        `;
                        
                        content.innerHTML = `
                            <h3 style="margin-bottom: 1rem; color: var(--text-color);">cURL Command</h3>
                            <pre style="background: var(--input-bg); padding: 1rem; border-radius: 4px; overflow: auto; color: var(--text-color); white-space: pre-wrap;">${curlCommand}</pre>
                            <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 1rem; background: var(--button-bg); color: var(--button-text); border: none; border-radius: 4px; padding: 0.5rem 1rem; cursor: pointer;">Close</button>
                        `;
                        
                        modal.appendChild(content);
                        document.body.appendChild(modal);
                        
                        // Close modal when clicking outside
                        modal.addEventListener('click', function(e) {
                            if (e.target === modal) {
                                modal.remove();
                            }
                        });
                    });
                }
            });

            // Add OAuth2 functionality
            // Remove dependency on external library and implement directly
            const fetchTokenBtn = document.getElementById('fetch-token');
            const tokenResult = document.getElementById('token-result');
            const tokenResponse = document.getElementById('token-response');
            
            // Setup Grant Type Toggle
            const grantTypeSelect = document.getElementById('grant-type');
            const passwordCredentialsDiv = document.getElementById('password-credentials');
            
            // Show/hide password fields based on grant type
            grantTypeSelect.addEventListener('change', function() {
                if (this.value === 'password') {
                    passwordCredentialsDiv.style.display = 'flex';
                } else {
                    passwordCredentialsDiv.style.display = 'none';
                }
            });

            // Fetch Token Button
            fetchTokenBtn.addEventListener('click', async function() {
                // Get form values
                const grantType = document.getElementById('grant-type').value;
                const tokenUrl = document.getElementById('token-url').value.trim();
                const clientId = document.getElementById('client-id').value.trim();
                const clientSecret = document.getElementById('client-secret').value.trim();
                
                // Validate inputs
                if (!tokenUrl) {
                    alert('Please enter a token URL');
                    return;
                }
                
                if (!clientId || !clientSecret) {
                    alert('Client ID and Client Secret are required');
                    return;
                }
                
                // Additional validation for password grant
                let username = '';
                let password = '';
                if (grantType === 'password') {
                    username = document.getElementById('username').value.trim();
                    password = document.getElementById('password').value.trim();
                    
                    if (!username || !password) {
                        alert('Username and Password are required for Password grant type');
                        return;
                    }
                }
                
                fetchTokenBtn.disabled = true;
                fetchTokenBtn.textContent = 'Fetching...';
                
                try {
                    // Prepare request body based on grant type
                    const formData = new URLSearchParams();
                    formData.append('grant_type', grantType);
                    
                    if (grantType === 'password') {
                        formData.append('username', username);
                        formData.append('password', password);
                    }
                    
                    // Create Authorization header with Basic auth
                    const authHeader = 'Basic ' + btoa(clientId + ':' + clientSecret);
                    
                    // Make request to token endpoint
                    const response = await fetch(tokenUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Authorization': authHeader
                        },
                        body: formData
                    });
                    
                    // Parse response
                    const contentType = response.headers.get('content-type');
                    let token;
                    
                    if (contentType && contentType.includes('application/json')) {
                        token = await response.json();
                    } else {
                        // Handle non-JSON responses
                        const text = await response.text();
                        try {
                            token = JSON.parse(text);
                        } catch (e) {
                            // If it's not JSON, create a simple object with the text
                            token = { response: text };
                        }
                    }
                    
                    if (!response.ok) {
                        throw new Error(`Error: ${response.status} ${response.statusText}`);
                    }
                    
                    // Show token result
                    tokenResult.style.display = 'block';
                    tokenResponse.textContent = JSON.stringify(token, null, 2);
                    
                    // Add the access token to the headers
                    const accessToken = token.access_token;
                    if (accessToken) {
                        // Check if Authorization header already exists
                        let authHeaderExists = false;
                        const headersList = document.getElementById('headers-list');
                        const headerRows = headersList.querySelectorAll('.key-value-row');
                        
                        for (const row of headerRows) {
                            const keyInput = row.querySelector('.key-input');
                            if (keyInput.value.toLowerCase() === 'authorization') {
                                const valueInput = row.querySelector('.value-input');
                                valueInput.value = `Bearer ${accessToken}`;
                                authHeaderExists = true;
                                break;
                            }
                        }
                        
                        // If no Authorization header exists, add a new one
                        if (!authHeaderExists) {
                            // Find the Add Header button and click it
                            const addHeaderBtn = document.getElementById('add-header-btn');
                            addHeaderBtn.click();
                            
                            // Get the newly added row
                            const newRow = headersList.lastElementChild;
                            const keyInput = newRow.querySelector('.key-input');
                            const valueInput = newRow.querySelector('.value-input');
                            
                            keyInput.value = 'Authorization';
                            valueInput.value = `Bearer ${accessToken}`;
                        }
                        
                        // Switch to Headers tab
                        const headersTab = document.querySelector('.request-tabs .tab-btn[data-tab="headers"]');
                        headersTab.click();
                        
                        alert('Access token added to headers as Bearer token!');
                    }
                } catch (error) {
                    console.error('Error fetching token:', error);
                    
                    // Display the error in the token result area
                    tokenResult.style.display = 'block';
                    
                    // Check if it's a CORS error
                    if (error.message === 'Failed to fetch' || 
                        error.message.includes('NetworkError') || 
                        error.message.includes('CORS')) {
                        
                        const corsErrorMessage = `CORS Error: The request was blocked by the browser due to Cross-Origin Resource Sharing (CORS) policy restrictions.

Possible solutions:
1. The API server needs to include appropriate CORS headers (Access-Control-Allow-Origin)
2. Use a CORS proxy for testing purposes
3. If this is your own API, configure it to allow requests from this origin
4. For local testing, you might need to disable CORS in your browser (not recommended for regular browsing)

Technical details: ${error.message}`;
                        
                        tokenResponse.textContent = corsErrorMessage;
                    } else {
                        tokenResponse.textContent = `Error: ${error.message}`;
                    }
                } finally {
                    fetchTokenBtn.disabled = false;
                    fetchTokenBtn.textContent = 'Fetch Token';
                }
            });
        });
    </script>
</body>
</html> 